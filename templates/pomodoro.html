{% extends "base.html" %}

{% block title %}ポモドーロタイマー{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="card-title mb-3">ポモドーロタイマー</h2>

        <p class="text-muted mb-1">
          25分作業 ＋ 5分休憩 を繰り返すシンプルなタイマーです。
        </p>

        <!-- UTC 時刻 -->
        <p class="small text-muted">
          API から取得した現在の UTC 時刻：
          <span id="server-time">読み込み中...</span>
        </p>

        <hr>

        <!-- 状態表示 -->
        <h4 id="phase-label" class="mb-3 text-center">作業中</h4>

        <!-- カウントダウン -->
        <div class="display-3 text-center mb-4" id="timer-display">
          25:00
        </div>

        <!-- 操作ボタン -->
        <div class="d-flex justify-content-center gap-2">
          <button id="start-btn" class="btn btn-primary">スタート</button>
          <button id="pause-btn" class="btn btn-outline-secondary">一時停止</button>
          <button id="reset-btn" class="btn btn-outline-danger">リセット</button>
        </div>

        <!-- 環境音 -->
        <hr>
        <h5 class="mb-2">環境音</h5>
        <div class="d-flex align-items-center gap-2 mb-3">
          <select id="sound-tag" class="form-select" style="max-width: 220px;">
            <option value="rain">rain</option>
            <option value="cafe">cafe</option>
            <option value="white noise">white noise</option>
            <option value="birds">birds</option>
          </select>
          <button id="sound-load" class="btn btn-outline-primary">音を変更</button>
          <button id="sound-toggle" class="btn btn-outline-secondary">再生 / 停止</button>
        </div>

        <audio id="ambient-audio" loop></audio>
        <p class="small text-muted mb-0">
          再生中：<span id="sound-now">なし</span>
        </p>

        <!-- Todoist -->
        <hr>
        <h5 class="mb-2">今日のタスク（Todoist連携）</h5>

        <div class="d-flex align-items-center gap-2 mb-2">
          <input id="todoist-content" class="form-control"
                 placeholder="例：レポート作成 / Manaba提出 / Blender練習30分">
          <button id="todoist-add" class="btn btn-success">追加</button>
          <button id="todoist-refresh" class="btn btn-outline-secondary">更新</button>
        </div>

        <ul class="list-group mt-2" id="todoist-list"></ul>
        <p class="small text-muted mt-2 mb-0" id="todoist-status"></p>

      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Pomodoro Timer
========================= */
const workMinutesDefault = 25;
const breakMinutesDefault = 5;

let isWorking = true;
let remainingSeconds = workMinutesDefault * 60;
let timerId = null;

const phaseLabel = document.getElementById("phase-label");
const timerDisplay = document.getElementById("timer-display");

function updateDisplay() {
  const m = String(Math.floor(remainingSeconds / 60)).padStart(2, "0");
  const s = String(remainingSeconds % 60).padStart(2, "0");
  timerDisplay.textContent = `${m}:${s}`;
  phaseLabel.textContent = isWorking ? "作業中" : "休憩中";
}

function tick() {
  if (remainingSeconds > 0) {
    remainingSeconds--;
    updateDisplay();
    return;
  }
  isWorking = !isWorking;
  remainingSeconds = (isWorking ? workMinutesDefault : breakMinutesDefault) * 60;
  updateDisplay();
}

document.getElementById("start-btn").onclick = () => {
  if (!timerId) timerId = setInterval(tick, 1000);
};
document.getElementById("pause-btn").onclick = () => {
  clearInterval(timerId);
  timerId = null;
};
document.getElementById("reset-btn").onclick = () => {
  clearInterval(timerId);
  timerId = null;
  isWorking = true;
  remainingSeconds = workMinutesDefault * 60;
  updateDisplay();
};

updateDisplay();

/* =========================
   UTC Time (backend API)
========================= */
const serverTimeSpan = document.getElementById("server-time");

async function fetchServerTime() {
  try {
    const res = await fetch("/api/time/utc/");
    const data = await res.json();

    if (!res.ok || !data.datetime) {
      throw new Error(data.error || "failed");
    }

    const dt = data.datetime.split(".")[0].replace("T", " ");
    serverTimeSpan.textContent = dt + " (UTC)";
  } catch (e) {
    console.error(e);
    serverTimeSpan.textContent = "取得に失敗しました";
  }
}
fetchServerTime();

/* =========================
   Freesound
========================= */
const audioEl = document.getElementById("ambient-audio");
const soundNow = document.getElementById("sound-now");

async function loadSound(tag) {
  const res = await fetch(`/api/sound/?tag=${encodeURIComponent(tag)}`);
  const data = await res.json();
  if (!res.ok) {
    alert(data.error || "音の取得に失敗しました");
    return;
  }
  audioEl.src = data.mp3Url;
  soundNow.textContent = `${data.name} (${data.tag})`;
  try { await audioEl.play(); } catch {}
}

document.getElementById("sound-load").onclick =
  () => loadSound(document.getElementById("sound-tag").value);

document.getElementById("sound-toggle").onclick =
  () => audioEl.paused ? audioEl.play() : audioEl.pause();

loadSound("rain");

/* =========================
   Todoist
========================= */
const listEl = document.getElementById("todoist-list");
const statusEl = document.getElementById("todoist-status");
const inputEl = document.getElementById("todoist-content");

function escapeHtml(s) {
  return s.replace(/[&<>"']/g, c =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
  );
}

async function refreshTasks() {
  const res = await fetch("/api/todoist/tasks/");
  const data = await res.json();

  if (!res.ok) {
    statusEl.textContent =
      `${data.error || "Todoist error"} (${data.status || ""})`;
    return;
  }

  const tasks = data.tasks || [];
  listEl.innerHTML = tasks.map(t => `
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span>${escapeHtml(t.content)}</span>
      <button class="btn btn-sm btn-outline-success" data-id="${t.id}">完了</button>
    </li>
  `).join("");

  statusEl.textContent = `未完了タスク：${tasks.length}`;
}

document.getElementById("todoist-add").onclick = async () => {
  const content = inputEl.value.trim();
  if (!content) return;

  const res = await fetch("/api/todoist/task/create/", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({content})
  });
  const data = await res.json();

  if (!res.ok) {
    statusEl.textContent =
      `${data.error || "Todoist create failed"} (${data.status || ""})`;
    return;
  }

  inputEl.value = "";
  refreshTasks();
};

document.getElementById("todoist-refresh").onclick = refreshTasks;

listEl.onclick = async (e) => {
  const btn = e.target.closest("button[data-id]");
  if (!btn) return;

  const res = await fetch("/api/todoist/task/close/", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({taskId: btn.dataset.id})
  });
  const data = await res.json();

  if (!res.ok) {
    statusEl.textContent =
      `${data.error || "Todoist close failed"} (${data.status || ""})`;
    return;
  }
  refreshTasks();
};

refreshTasks();
</script>
{% endblock %}
